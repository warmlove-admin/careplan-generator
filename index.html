<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>照顧計畫敘述產生器（多段落／可編輯）</title>
  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc; }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"; margin:0; background:var(--bg); color:#0b1220; }
    .container{ max-width:1200px; margin:0 auto; padding:24px; }
    h1{ font-size:24px; margin:0 0 12px; }
    p.lead{ color:#475569; margin:0 0 16px; }
    .grid{ display:grid; grid-template-columns:360px 1fr; gap:16px; }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }
    .card{ background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:0 1px 0 rgba(0,0,0,.03); }
    .card h2{ font-size:18px; padding:16px 16px 0; margin:0; }
    .card .body{ padding:16px; }
    .row{ margin-bottom:12px; }
    label.block{ display:block; font-size:14px; color:#334155; margin-bottom:6px; }
    input[type="date"],input[type="text"],select,textarea{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #cbd5e1; background:#fff; box-sizing:border-box; }
    textarea{ min-height:120px; font-size:15px; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{ display:inline-flex; align-items:center; gap:8px; border:1px solid #cbd5e1; background:#f8fafc; padding:8px 10px; border-radius:12px; cursor:pointer; user-select:none; }
    .chip input{ transform:scale(1.1); }
    .seg{ display:flex; gap:8px; flex-wrap:wrap; }
    .seg input{ display:none; }
    .seg label{ border:1px solid #cbd5e1; padding:8px 12px; border-radius:12px; cursor:pointer; background:#f8fafc; }
    .seg input:checked + label{ background:var(--ink); color:#fff; border-color:var(--ink); }
    .small{ font-size:12px; color:var(--muted); }
    .flex{ display:flex; align-items:center; gap:10px; }
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid var(--ink); background:var(--ink); color:#fff; cursor:pointer; }
    .btn.secondary{ background:#f1f5f9; color:#0b1220; border-color:#cbd5e1; }
    .muted{ color:var(--muted); font-size:12px; }
    .sectitle{ font-weight:600; font-size:14px; margin-top:10px; margin-bottom:6px; }
    .section-list label{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .divider{ height:1px; background:var(--line); margin:12px 0; }
    details{ border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:#fff; }
    details + details{ margin-top:10px; }
    summary{ font-weight:600; cursor:pointer; outline:0; }
    .twocol{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:760px){ .twocol{ grid-template-columns:1fr; } }
    textarea#output{ min-height:420px; border-radius:12px; }
    .right-sticky{ position:sticky; top:12px; align-self:start; }
    @media (max-width:980px){ .right-sticky{ top:8px; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>照顧計畫敘述產生器（多段落／可編輯）</h1>
    <p class="lead">左側勾選或輸入即自動更新右側文字（首次開啟不會自動產生）。</p>

    <div class="grid">
      <!-- 左側 -->
      <div class="card">
        <h2>段落選擇與輸入</h2>
        <div class="body">
          <div class="sectitle">要生成的段落（可複選）</div>
          <div class="section-list">
            <label><input type="checkbox" id="sec1" checked> 1. 訪視摘要</label>
            <label><input type="checkbox" id="sec2"> 2. 需求與問題評估</label>
            <label><input type="checkbox" id="sec3"> 3. 照護目標</label>
            <label><input type="checkbox" id="sec4"> 4. 服務計畫</label>
            <label><input type="checkbox" id="sec5"> 5. 風險與衛教</label>
            <label><input type="checkbox" id="sec6"> 6. 追蹤與回訪</label>
          </div>
          <div class="divider"></div>

          <details open>
            <summary>（第1段）訪視摘要</summary>
            <div class="row">
              <label class="block">訪視日期（西元）</label>
              <input id="visitDate" type="date">
              <div class="muted">會自動轉民國格式，例如 2025-08-12 → 114/08/12</div>
            </div>

            <div class="row">
              <label class="block">受訪對象（可複選）</label>
              <div id="parties" class="chips"></div>
            </div>

            <div class="row"><label class="block">意識</label><div class="seg" id="awareness"></div></div>
            <div class="row"><label class="block">聽力</label><div class="seg" id="hearing"></div></div>
            <div class="row"><label class="block">認知功能</label><div class="seg" id="cognition"></div></div>
            <div class="row"><label class="block">是否能切題對談</label><div class="seg" id="onTopic"></div></div>

            <div class="row">
              <label class="block">疾病史</label>
              <div class="flex">
                <input id="noDisease" type="checkbox"><label for="noDisease" class="small">無疾病史</label>
              </div>
              <div id="diseases" class="chips" style="margin-top:6px;"></div>
              <div class="row" id="hospitalRow" style="margin-top:8px;">
                <label class="block">追蹤醫院（可複選）</label>
                <div id="hospitals" class="chips"></div>
              </div>
            </div>

            <div class="row"><label class="block">步態</label><div class="seg" id="gait"></div></div>

            <div class="row">
              <label class="block">是否使用輔具</label>
              <div class="flex">
                <input id="useAid" type="checkbox">
                <label for="useAid" class="small"><span id="useAidLabel">未使用</span></label>
              </div>
              <div id="aids" class="chips" style="margin-top:6px; display:none;"></div>
            </div>

            <div class="row"><label class="block">日常生活自理程度</label><div class="seg" id="adl"></div></div>
          </details>

          <details>
            <summary>（第2段）需求與問題評估</summary>
            <div class="row"><label class="block">勾選重點（可複選）</label><div id="needs" class="chips"></div></div>
            <div class="row"><label class="block">補充說明</label><textarea id="needsNote" placeholder="例：近期跌倒兩次，夜間如廁不便；家屬照顧壓力增加等。"></textarea></div>
          </details>

          <details>
            <summary>（第3段）照護目標</summary>
            <div class="row"><label class="block">目標（可複選）</label><div id="goals" class="chips"></div></div>
            <div class="row"><label class="block">補充/量化指標</label><textarea id="goalsNote" placeholder="例：一週內學會助行器正確使用；一個月內跌倒事件為 0。"></textarea></div>
          </details>

          <details>
            <summary>（第4段）服務計畫</summary>
            <div class="row"><label class="block">服務項目（可複選）</label><div id="services" class="chips"></div></div>
            <div class="row"><label class="block">時程/頻率</label><input id="serviceSched" type="text" placeholder="例：每週二四居服 2hr；每月一次護理評估"></div>
            <div class="row"><label class="block">補充說明</label><textarea id="servicesNote" placeholder="例：同步申請輔具補助；安排交通接送門診。"></textarea></div>
          </details>

          <details>
            <summary>（第5段）風險與衛教</summary>
            <div class="row"><label class="block">衛教主題（可複選）</label><div id="education" class="chips"></div></div>
            <div class="row"><label class="block">衛教重點/注意事項</label><textarea id="educationNote" placeholder="例：地面防滑、夜間照明、正確用藥與回診提醒等。"></textarea></div>
          </details>

          <details>
            <summary>（第6段）追蹤與回訪</summary>
            <div class="twocol">
              <div class="row"><label class="block">下次追蹤日期（西元）</label><input id="nextDate" type="date"></div>
              <div class="row"><label class="block">追蹤方式</label><div class="seg" id="followType"></div></div>
            </div>
            <div class="row"><label class="block">負責人/單位</label><input id="followOwner" type="text" placeholder="例：個管員王小華 / 中心名"></div>
            <div class="row"><label class="block">備註</label><textarea id="followNote" placeholder="其它安排或注意事項..."></textarea></div>
          </details>

          <div class="divider"></div>
          <div class="muted">說明：左側變更會自動更新右側被勾選的段落。</div>
        </div>
      </div>

      <!-- 右側 -->
      <div class="card right-sticky">
        <h2 style="display:flex;justify-content:space-between;align-items:center;padding-right:16px;">
          <span>自動產生敘述（可編輯）</span>
          <div style="display:flex; gap:8px;">
            <button id="clearBtn" class="btn secondary">清空</button>
            <button id="copyBtn" class="btn">複製文字</button>
          </div>
        </h2>
        <div class="body">
          <textarea id="output" placeholder="左側變更會自動更新到這裡；你也可以在此手動微調文字。"></textarea>
          <div class="muted">系統以段落標籤合併（例如【第1段：訪視摘要】）。若某段仍勾選，手動改寫後再變更左側選項會以最新表單覆蓋該段。</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---- 選項常數 ----
    var VISIT_PARTIES = ["個案","案長女","案次女","配偶","主要照顧者"];
    var AWARENESS = ["清楚","模糊"];
    var HEARING = ["正常","右耳重聽","左耳重聽","雙耳重聽"];
    var COGNITION = ["正常","欠佳"];
    var ON_TOPIC = ["能夠","無法"];
    var DISEASES = ["高血壓","糖尿病","中風","心臟病","腎臟病"];
    var HOSPITALS = ["汐止國泰","內湖三總","忠孝醫院"];     // 可複選
    var GAIT = ["穩健","不穩"];
    var WALK_AID = ["助行器","拐杖","輪椅"];
    var ADL_LEVEL = ["可自理","部分需協助（如廁/沐浴）","完全無法自理"];

    var NEEDS = ["醫療追蹤/用藥管理","ADL/IADL 自理能力","認知/情緒","環境安全","營養/吞嚥","經濟資源","照顧負荷","交通接送","其他"];
    var GOALS = ["維持生活自理","改善步態穩定","提升居家安全","增加衛教遵從","強化家庭支持","改善營養狀況"];
    var SERVICES = ["居家服務","居家護理","居家復健","日照中心","送餐服務","交通接送","個案管理/家訪","轉介社工","申請輔具","居家環境改善"];
    var EDU_TOPICS = ["跌倒預防","用藥安全","壓瘡預防","吞嚥與營養","運動復健","緊急應變/聯絡流程"];
    var FOLLOW_TYPES = ["電話追蹤","到宅訪視","門診陪同"];

    // ---- 小工具 ----
    function $(id){ return document.getElementById(id); }
    function toROC(dateStr){
      if(!dateStr) return "____/__/__";
      var d = new Date(dateStr);
      if(isNaN(d)) return "____/__/__";
      var y = d.getFullYear() - 1911;
      var m = String(d.getMonth()+1).padStart(2,"0");
      var day = String(d.getDate()).padStart(2,"0");
      return y + "/" + m + "/" + day;
    }
    function renderChips(containerId, list, stateSet){
      var box = $(containerId);
      if(!box) return;
      box.innerHTML = "";
      list.forEach(function(txt){
        var label = document.createElement("label");
        label.className = "chip";
        var input = document.createElement("input");
        input.type = "checkbox";
        input.checked = stateSet.has(txt);
        input.addEventListener("change", function(){ if(input.checked) stateSet.add(txt); else stateSet.delete(txt); });
        label.appendChild(input);
        label.appendChild(document.createTextNode(txt));
        box.appendChild(label);
      });
    }
    function renderSegment(containerId, list, stateObj){
      var box = $(containerId);
      if(!box) return;
      box.innerHTML = "";
      list.forEach(function(txt){
        var id = containerId + "-" + txt;
        var input = document.createElement("input");
        input.type = "radio"; input.name = containerId; input.id = id;
        input.checked = (stateObj.value === txt);
        input.addEventListener("change", function(){ stateObj.value = txt; });
        var label = document.createElement("label");
        label.htmlFor = id; label.textContent = txt;
        box.appendChild(input); box.appendChild(label);
      });
    }
    function chipsToList(set){ return set.size ? Array.from(set).join("、") : ""; }

    // ---- 狀態 ----
    var state = {
      visitDate:"", parties:new Set(["個案"]),
      awareness:{value:"清楚"}, hearing:{value:"正常"}, cognition:{value:"正常"}, onTopic:{value:"能夠"},
      noDisease:false, diseases:new Set(), hospitals:new Set(),
      gait:{value:"穩健"}, useAid:false, aids:new Set(), adl:{value:"可自理"},
      needs:new Set(), needsNote:"", goals:new Set(), goalsNote:"",
      services:new Set(), serviceSched:"", servicesNote:"",
      education:new Set(), educationNote:"",
      nextDate:"", followType:{value:"電話追蹤"}, followOwner:"", followNote:""
    };

    // ---- 段落產生器（不使用任何括號包住清單） ----
    function genSection1(){
      var rocDate = toROC(state.visitDate);
      var parties = state.parties.size ? Array.from(state.parties).join("、") : "個案";

      var diseaseFinal = "無疾病史";
      if(!state.noDisease && state.diseases.size){
        var dis = Array.from(state.diseases).join(" / ");
        var hos = state.hospitals.size ? "，規律於" + Array.from(state.hospitals).join("、") + "追蹤" : "";
        diseaseFinal = "有" + dis + "疾病史" + hos;
      }

      var walking = state.useAid ? ("行走使用" + (state.aids.size? Array.from(state.aids).join("、") : "助行器、拐杖、輪椅")) : "行走未使用輔具";

      var adl = "基本日常生活可自理";
      if(state.adl.value === "部分需協助（如廁/沐浴）") adl = "基本日常生活部分（如廁/沐浴）需協助";
      if(state.adl.value === "完全無法自理") adl = "基本日常生活完全無法自理";

      var sentence = "於" + rocDate + "訪視" + parties + "，個案意識" + state.awareness.value +
                     "，聽力" + state.hearing.value + "，認知功能" + state.cognition.value +
                     "，" + state.onTopic.value + "切題對談，" + diseaseFinal +
                     "；步態" + state.gait.value + "，" + walking + "；" + adl + "。";
      return "【第1段：訪視摘要】\n" + sentence + "\n";
    }
    function genSection2(){
      var list = chipsToList(state.needs);
      var note = (state.needsNote||"").trim();
      var main = list ? ("主要需求/問題評估：" + list + "。") : "主要需求/問題評估：—。";
      var extra = note ? ("補充：" + note) : "";
      return "【第2段：需求與問題評估】\n" + main + " " + extra + "\n";
    }
    function genSection3(){
      var list = chipsToList(state.goals);
      var note = (state.goalsNote||"").trim();
      var main = list ? ("照護目標：" + list + "。") : "照護目標：—。";
      var extra = note ? ("量化/補充：" + note) : "";
      return "【第3段：照護目標】\n" + main + " " + extra + "\n";
    }
    function genSection4(){
      var list = chipsToList(state.services);
      var sched = (state.serviceSched||"").trim();
      var note  = (state.servicesNote||"").trim();
      var main = list ? ("服務計畫：" + list + "。") : "服務計畫：—。";
      var s1 = sched ? ("時程/頻率：" + sched + "。") : "";
      var s2 = note ? ("補充：" + note) : "";
      return "【第4段：服務計畫】\n" + main + " " + s1 + " " + s2 + "\n";
    }
    function genSection5(){
      var list = chipsToList(state.education);
      var note = (state.educationNote||"").trim();
      var main = list ? ("風險與衛教：" + list + "。") : "風險與衛教：—。";
      var extra = note ? ("重點：" + note) : "";
      return "【第5段：風險與衛教】\n" + main + " " + extra + "\n";
    }
    function genSection6(){
      var dateStr = state.nextDate ? toROC(state.nextDate) : "____/__/__";
      var who = (state.followOwner||"").trim();
      var note = (state.followNote||"").trim();
      var main = "下次追蹤：" + dateStr + "，方式：" + state.followType.value + (who ? "，負責：" + who : "") + "。";
      var extra = note ? ("備註：" + note) : "";
      return "【第6段：追蹤與回訪】\n" + main + " " + extra + "\n";
    }

    var generators = {1:genSection1,2:genSection2,3:genSection3,4:genSection4,5:genSection5,6:genSection6};

    function getSelectedSections(){
      var arr = []; for(var i=1;i<=6;i++){ var el=$("sec"+i); if(el && el.checked) arr.push(i); }
      return arr;
    }
    function replaceSections(currentText, selected){
      var text = currentText || "";
      selected.forEach(function(n){
        var tag = "【第" + n + "段：";
        var re = new RegExp("^" + tag + "[\\s\\S]*?(?=^【第\\d+段：|\\s*$)", "gm");
        text = text.replace(re, "");
      });
      var parts = selected.map(function(n){ return generators[n](); });
      text = (text.trim()? text.trim()+"\n\n" : "") + parts.join("\n");
      return text.trim() + "\n";
    }
    function autoRegenerate(){
      var selected = getSelectedSections();
      if(selected.length===0) return;
      var cur = $("output").value;
      $("output").value = replaceSections(cur, selected);
      $("output").scrollTop = $("output").scrollHeight;
    }
    var regenScheduled = false;
    function scheduleAutoRegenerate(){
      if (regenScheduled) return;
      regenScheduled = true;
      requestAnimationFrame(function(){ regenScheduled = false; autoRegenerate(); });
    }

    // 初始化（DOMContentLoaded 之後）
    window.addEventListener("DOMContentLoaded", function(){
      $("visitDate").addEventListener("input", function(e){ state.visitDate = e.target.value; });

      renderChips("parties", VISIT_PARTIES, state.parties);
      renderSegment("awareness", AWARENESS, state.awareness);
      renderSegment("hearing", HEARING, state.hearing);
      renderSegment("cognition", COGNITION, state.cognition);
      renderSegment("onTopic", ON_TOPIC, state.onTopic);
      renderChips("diseases", DISEASES, state.diseases);
      renderChips("hospitals", HOSPITALS, state.hospitals); // 可複選
      renderSegment("gait", GAIT, state.gait);
      renderChips("aids", WALK_AID, state.aids);
      renderSegment("adl", ADL_LEVEL, state.adl);

      $("noDisease").addEventListener("change", function(e){
        state.noDisease = e.target.checked;
        $("diseases").style.opacity = state.noDisease ? 0.4 : 1;
        $("diseases").style.pointerEvents = state.noDisease ? "none" : "auto";
        $("hospitalRow").style.display = state.noDisease ? "none" : "block";
        if(state.noDisease){ state.diseases.clear(); state.hospitals.clear(); }
      });
      $("useAid").addEventListener("change", function(e){
        state.useAid = e.target.checked;
        $("useAidLabel").textContent = state.useAid ? "使用" : "未使用";
        $("aids").style.display = state.useAid ? "flex" : "none";
        if(!state.useAid) state.aids.clear();
      });

      renderChips("needs", NEEDS, state.needs);
      $("needsNote").addEventListener("input", function(e){ state.needsNote = e.target.value; });

      renderChips("goals", GOALS, state.goals);
      $("goalsNote").addEventListener("input", function(e){ state.goalsNote = e.target.value; });

      renderChips("services", SERVICES, state.services);
      $("serviceSched").addEventListener("input", function(e){ state.serviceSched = e.target.value; });
      $("servicesNote").addEventListener("input", function(e){ state.servicesNote = e.target.value; });

      renderChips("education", EDU_TOPICS, state.education);
      $("educationNote").addEventListener("input", function(e){ state.educationNote = e.target.value; });

      renderSegment("followType", FOLLOW_TYPES, state.followType);
      $("nextDate").addEventListener("input", function(e){ state.nextDate = e.target.value; });
      $("followOwner").addEventListener("input", function(e){ state.followOwner = e.target.value; });
      $("followNote").addEventListener("input", function(e){ state.followNote = e.target.value; });

      var leftCard = document.querySelectorAll(".grid .card")[0];
      if(leftCard){
        leftCard.addEventListener("input", scheduleAutoRegenerate);
        leftCard.addEventListener("change", scheduleAutoRegenerate);
      }

      $("copyBtn").addEventListener("click", function(){
        navigator.clipboard.writeText($("output").value).then(function(){
          var btn=$("copyBtn"), old=btn.textContent; btn.textContent="已複製"; setTimeout(function(){ btn.textContent=old; },1200);
        }).catch(function(){ alert("無法複製，請手動選取文字。"); });
      });
      $("clearBtn").addEventListener("click", function(){ $("output").value=""; });
    });
  </script>
</body>
</html>

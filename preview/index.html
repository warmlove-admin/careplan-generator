<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>照顧計畫敘述產生器（多段落 / 可編輯）</title>
  <link rel="icon" href="data:,"><!-- 避免 favicon 404 -->
  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"; margin: 0; background: var(--bg); color:#0b1220;}
    .container { max-width: 1200px; margin: 0 auto; padding: 24px;}
    h1 { font-size: 24px; margin: 0 0 12px; }
    p.lead { color:#475569; margin: 0 0 16px;}
    .grid { display: grid; grid-template-columns: 360px 1fr; gap: 16px; }
    @media(max-width: 980px){ .grid{ grid-template-columns: 1fr; } }
    .card { background: white; border: 1px solid var(--line); border-radius: 14px; box-shadow: 0 1px 0 rgba(0,0,0,0.03); }
    .card h2 { font-size: 18px; padding: 16px 16px 0; margin: 0;}
    .card .body { padding: 16px; }
    .row { margin-bottom: 12px; }
    label.block { display:block; font-size: 14px; color:#334155; margin-bottom: 6px; }
    input[type="date"], input[type="text"], textarea { width: 100%; padding: 10px 12px; border-radius: 10px; border:1px solid #cbd5e1; background:#fff; box-sizing: border-box;}
    textarea { min-height: 180px; font-size: 15px; }
    .chips { display:flex; gap:8px; flex-wrap: wrap; }
    .chip { display:inline-flex; align-items:center; gap:8px; border:1px solid #cbd5e1; background:#f8fafc; padding:8px 10px; border-radius:12px; cursor:pointer; user-select:none; }
    .chip input { transform: scale(1.1); }
    .sectitle { font-weight:600; font-size:14px; margin-top:10px; margin-bottom:6px;}
    .section-list label { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .divider { height:1px; background:var(--line); margin:12px 0; }
    details { border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:#fff; }
    details + details { margin-top:10px; }
    summary { font-weight:600; cursor:pointer; outline:none; }
    .twocol { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media(max-width:760px){ .twocol{ grid-template-columns:1fr; } }

    /* sticky 右側 + 切換按鈕 */
    .right-sticky { position: sticky; top: 12px; align-self: start; }
    @media(max-width:980px){ .right-sticky{ top: 8px; } }
    .tabs { display:flex; flex-wrap: wrap; gap:8px; padding:0 16px 12px; }
    .tab { border:1px solid #cbd5e1; background:#f8fafc; color:#0b1220; padding:8px 10px; border-radius:10px; cursor:pointer; }
    .tab.active { background:var(--ink); color:#fff; border-color:var(--ink); }

    .btn { padding:10px 14px; border-radius:10px; border:1px solid var(--ink); background:var(--ink); color:#fff; cursor:pointer; }
    .btn.secondary { background:#f1f5f9; color:var(--ink); border-color:#cbd5e1; }

    .muted { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>照顧計畫敘述產生器（多段落 / 可編輯）</h1>
    <p class="lead">左側變更自動更新右側；上方按鈕可切換各段編輯。你手動改過的段落不會再被自動覆寫。</p>

    <div class="grid">
      <!-- 左側 -->
      <div class="card">
        <h2>段落選擇與輸入</h2>
        <div class="body">
          <div class="sectitle">要生成的段落（可複選）</div>
          <div class="section-list">
            <label><input type="checkbox" id="sec1" checked> 1. 訪視摘要</label>
            <label><input type="checkbox" id="sec2" checked> 2. 需求與問題評估</label>
            <label><input type="checkbox" id="sec3"> 3. 照顧目標</label>
            <label><input type="checkbox" id="sec4"> 4. 照顧計畫</label>
            <label><input type="checkbox" id="sec5"> 5. 風險與衛教</label>
            <label><input type="checkbox" id="sec6"> 6. 追蹤與回訪</label>
          </div>
          <div class="divider"></div>

          <!-- 第1段 -->
          <details open>
            <summary>（第1段）訪視摘要</summary>

            <div class="row">
              <label class="block">訪視日期（西元）</label>
              <input id="visitDate" type="date" />
              <div class="muted">會轉民國，例如 2025-08-12 → 114/08/12</div>
            </div>

            <div class="row"><label class="block">受訪對象（可複選）</label><div id="parties" class="chips"></div></div>
            <div class="row"><label class="block">意識（複選）</label><div id="awareness" class="chips"></div></div>
            <div class="row"><label class="block">聽力（複選）</label><div id="hearing" class="chips"></div></div>
            <div class="row"><label class="block">認知功能（複選）</label><div id="cognition" class="chips"></div></div>
            <div class="row"><label class="block">是否能切題對談（複選）</label><div id="onTopic" class="chips"></div></div>

            <div class="row">
              <label class="block">疾病史</label>
              <div class="chips"><label class="chip"><input id="noDisease" type="checkbox">無疾病史</label></div>
              <div id="diseases" class="chips" style="margin-top:6px;"></div>
              <div class="row" id="hospitalRow" style="margin-top:8px;">
                <label class="block">追蹤醫院（可複選）</label>
                <div id="hospitals" class="chips"></div>
              </div>
            </div>

            <div class="row"><label class="block">皮膚完整性（複選）</label><div id="skinIntegrity" class="chips"></div></div>
            <div class="row">
              <label class="block">壓瘡</label>
              <div class="chips"><label class="chip"><input id="hasBedsore" type="checkbox">有壓瘡</label></div>
              <div id="bedsoreBlock" style="display:none; margin-top:6px;">
                <div class="row"><label class="block">壓瘡部位（複選）</label><div id="bedsoreSites" class="chips"></div></div>
                <div class="row"><label class="block">壓瘡面積</label><input id="bedsoreArea" type="text" placeholder="例：3x2；或 5"></div>
              </div>
            </div>

            <div class="row"><label class="block">步態（複選）</label><div id="gait" class="chips"></div></div>

            <div class="row">
              <label class="block">是否使用輔具</label>
              <div class="chips"><label class="chip"><input id="useAid" type="checkbox"><span id="useAidLabel">未使用</span></label></div>
              <div id="aids" class="chips" style="margin-top:6px; display:none;"></div>
            </div>

            <div class="row"><label class="block">日常生活自理程度（複選）</label><div id="adl" class="chips"></div></div>

            <div class="divider"></div>
            <!-- 第1段 第二小段 -->
            <div class="row"><label class="block">同住成員（複選）</label><div id="cohab" class="chips"></div></div>
            <div class="row"><label class="block">住所類型（複選）</label><div id="housing" class="chips"></div></div>
            <div class="row"><label class="block">外出能力（複選）</label><div id="outdoor" class="chips"></div>
              <div class="muted">對照：獨立→可自行外出；部份協助→他人陪同下可外出；<b>困難→外出困難，需大量協助</b>；爬梯機→外出須使用爬梯機。</div>
            </div>
            <div class="row"><label class="block">照顧支持（複選）</label><div id="support" class="chips"></div></div>
            <div class="row"><label class="block">主述需求（複選）</label><div id="demands" class="chips"></div></div>
            <!-- 新增：個管建議（複選） -->
            <div class="row"><label class="block">個管建議（複選）</label><div id="cmgr" class="chips"></div></div>
          </details>

          <!-- 第2段 -->
          <details>
            <summary>（第2段）需求與問題評估</summary>
            <div class="row"><label class="block">勾選問題（可複選）</label><div id="issues" class="chips"></div></div>
            <div class="row"><label class="block">補充說明</label><textarea id="needsNote" placeholder="例：近期跌倒兩次，夜間如廁不便；家屬照顧壓力增加等。"></textarea></div>
          </details>

          <!-- 第3段 -->
          <details><summary>（第3段）照顧目標</summary>
            <div class="row"><label class="block">目標（可複選）</label><div id="goals" class="chips"></div></div>
            <div class="row"><label class="block">補充/量化指標</label><textarea id="goalsNote" placeholder="例：一週內學會助行器正確使用；一個月內跌倒事件為 0。"></textarea></div>
          </details>

          <!-- 第4段 -->
          <details><summary>（第4段）照顧計畫</summary>
            <div class="row"><label class="block">服務項目（可複選）</label><div id="services" class="chips"></div></div>
            <div class="row"><label class="block">時程/頻率</label><input id="serviceSched" type="text" placeholder="例：每週二四居服 2hr；每月一次護理評估"></div>
            <div class="row"><label class="block">補充說明</label><textarea id="servicesNote" placeholder="例：同步申請輔具補助；安排交通接送門診。"></textarea></div>
          </details>

          <!-- 第5段 -->
          <details><summary>（第5段）風險與衛教</summary>
            <div class="row"><label class="block">衛教主題（可複選）</label><div id="education" class="chips"></div></div>
            <div class="row"><label class="block">衛教重點/注意事項</label><textarea id="educationNote" placeholder="例：地面防滑、夜間照明、正確用藥與回診提醒。"></textarea></div>
          </details>

          <!-- 第6段 -->
          <details><summary>（第6段）追蹤與回訪</summary>
            <div class="twocol">
              <div class="row"><label class="block">下次追蹤日期（西元）</label><input id="nextDate" type="date"></div>
              <div class="row"><label class="block">追蹤方式（複選）</label><div id="followType" class="chips"></div></div>
            </div>
            <div class="row"><label class="block">負責人/單位</label><input id="followOwner" type="text" placeholder="例：個管員王小華 / 中心名"></div>
            <div class="row"><label class="block">備註</label><textarea id="followNote" placeholder="其它安排或注意事項..."></textarea></div>
          </details>
        </div>
      </div>

      <!-- 右側：切換 + 編輯 -->
      <div class="card right-sticky">
        <h2 style="display:flex;justify-content:space-between;align-items:center;">
          <span>自動產生敘述（可編輯）</span>
          <span class="flex" style="display:flex;gap:8px;">
            <button id="clearThis" class="btn secondary">清空本段</button>
            <button id="copyBtn" class="btn">複製全部</button>
          </span>
        </h2>
        <div class="tabs" id="tabs">
          <button class="tab active" data-sec="1">訪視摘要</button>
          <button class="tab" data-sec="2">需求與問題評估</button>
          <button class="tab" data-sec="3">照顧目標</button>
          <button class="tab" data-sec="4">照顧計畫</button>
          <button class="tab" data-sec="5">風險與衛教</button>
          <button class="tab" data-sec="6">追蹤與回訪</button>
        </div>
        <div class="body">
          <textarea id="editor" placeholder="這裡顯示目前選取的段落；切換上方按鈕可改編其他段落。"></textarea>
          <div class="muted">左側變更只會覆寫「尚未手動修改」的段落；你在此輸入後，該段就不再被自動覆蓋（按『清空本段』可恢復自動）。</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== 常數 ===== */
    const NAMES = {1:"訪視摘要",2:"需求與問題評估",3:"照顧目標",4:"照顧計畫",5:"風險與衛教",6:"追蹤與回訪"};

    const VISIT_PARTIES = ["個案","案長女","案次女","配偶","主要照顧者"];
    const AWARENESS = ["清楚","模糊"];
    const HEARING   = ["正常","右耳重聽","左耳重聽","雙耳重聽"];
    const COGNITION = ["正常","欠佳"];
    const ON_TOPIC  = ["能夠","無法"];
    const DISEASES  = ["高血壓","糖尿病","中風","心臟病","腎臟病"];
    const HOSPITALS = ["汐止國泰","內湖三總","忠孝醫院"];
    const SKIN_INTEGRITY = ["粗糙乾裂","有傷口"];
    const BEDSORE_SITES  = ["骶尾部","足跟","髖部"];
    const GAIT      = ["穩健","不穩"];
    const WALK_AID  = ["助行器","拐杖","輪椅"];
    const ADL_LEVEL = ["可自理","部分需協助（如廁/沐浴）","完全無法自理"];

    const COHAB    = ["獨居","案妻","案子","案女","外看"];
    const HOUSING  = ["公寓","電梯大樓"];
    const OUTDOOR  = ["獨立","部份協助","困難","爬梯機"];
    const OUTDOOR_MAP = {
      "獨立":"可自行外出",
      "部份協助":"他人陪同下可外出",
      "困難":"外出困難，需大量協助",
      "爬梯機":"外出須使用爬梯機"
    };
    const SUPPORT = ["極佳","尚佳","薄弱"];
    const SUPPORT_MAP = {
      "極佳":"家庭關係緊密，支持度高",
      "尚佳":"照顧支持系統尚佳",
      "薄弱":"支持系統薄弱"
    };
    const DEMANDS = ["居家服務","日間照顧","交通接送","專業復能","喘息服務","輔具","無障礙環境改善"];

    const ISSUES = ["進食問題","洗澡問題","個人修飾問題","穿脫衣物問題","大小便控制問題","上廁所問題","走路問題","上下樓梯問題","購物或外出問題","跌倒風險","移位問題","使用電話問題","備餐問題","處理家務問題","用藥問題","處理財務問題","溝通問題","吞嚥問題","安全疑慮","照顧負荷過重","居住環境障礙","疼痛問題","皮膚照護問題"];

    const GOALS     = ["維持生活自理","改善步態穩定","提升居家安全","增加衛教遵從","強化家庭支持","改善營養狀況"];
    const SERVICES  = ["居家服務","居家護理","居家復健","日照中心","送餐服務","交通接送","個案管理/家訪","轉介社工","申請輔具","居家環境改善"];
    const EDU_TOPICS= ["跌倒預防","用藥安全","壓瘡預防","吞嚥與營養","運動復健","緊急應變/聯絡流程"];
    const FOLLOW_TYPES = ["電話追蹤","到宅訪視","門診陪同"];

    /* ===== 工具 ===== */
    const $ = (id)=>document.getElementById(id);
    function toROC(dateStr){
      if(!dateStr) return "____/__/__";
      const d = new Date(dateStr);
      if(isNaN(d)) return "____/__/__";
      const y = d.getFullYear() - 1911;
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}/${m}/${day}`;
    }
    function renderChips(containerId, list, stateSet){
      const box = $(containerId); box.innerHTML = "";
      list.forEach(txt=>{
        const label=document.createElement("label"); label.className="chip";
        const input=document.createElement("input"); input.type="checkbox"; input.checked=stateSet.has(txt);
        input.addEventListener("change",()=>{
          if(input.checked) stateSet.add(txt); else stateSet.delete(txt);
          // 第1段永遠需要重算
          maybeAuto(1);
          // 其他段落視容器決定
          if(containerId==="issues")     maybeAuto(2);
          if(containerId==="goals")      maybeAuto(3);
          if(containerId==="services")   maybeAuto(4);
          if(containerId==="education")  maybeAuto(5);
          if(containerId==="followType") maybeAuto(6);
        });
        label.appendChild(input); label.appendChild(document.createTextNode(txt)); box.appendChild(label);
      });
    }
    const chipsToList=set=> set.size? Array.from(set).join("、") : "";

    /* ===== 狀態 & 編輯儲存 ===== */
    const state = {
      visitDate:"", parties:new Set(["個案"]),
      awareness:new Set(), hearing:new Set(), cognition:new Set(), onTopic:new Set(),
      noDisease:false, diseases:new Set(), hospitals:new Set(),
      skin:new Set(), hasBedsore:false, bedsoreSites:new Set(), bedsoreArea:"",
      gait:new Set(), useAid:false, aids:new Set(), adl:new Set(),

      cohab:new Set(), housing:new Set(), outdoor:new Set(), support:new Set(),
      demands:new Set(),           // 家屬主述需求
      cmgr:new Set(),              // 個管建議（與 DEMANDS 同一組選項）

      issues:new Set(), needsNote:"",
      goals:new Set(), goalsNote:"",
      services:new Set(), serviceSched:"", servicesNote:"",
      education:new Set(), educationNote:"",
      nextDate:"", followType:new Set(), followOwner:"", followNote:""
    };

    const sections={1:"",2:"",3:"",4:"",5:"",6:""};
    const dirty   ={1:false,2:false,3:false,4:false,5:false,6:false};
    let active=1;

    const editor=$("editor");
    editor.addEventListener("input",()=>{ sections[active]=editor.value; dirty[active]=true; });

    function switchTo(n){
      active=n;
      document.querySelectorAll(".tab").forEach(b=> b.classList.toggle("active", Number(b.dataset.sec)===n));
      editor.value = sections[n] || "";
      editor.placeholder = `正在編輯【第${n}段：${NAMES[n]}】`;
    }
    document.querySelectorAll(".tab").forEach(btn=> btn.addEventListener("click",()=>switchTo(Number(btn.dataset.sec))));
    $("clearThis").addEventListener("click",()=>{ sections[active]=""; dirty[active]=false; editor.value=""; maybeAuto(active); });

    /* ===== 產生器 ===== */
    function gen1(){
      const rocDate = toROC(state.visitDate);
      const parties = state.parties.size? Array.from(state.parties).join("、") : "個案";

      const bits=[];
      if(state.awareness.size) bits.push("意識"+chipsToList(state.awareness));
      if(state.hearing.size)   bits.push("聽力"+chipsToList(state.hearing));
      if(state.cognition.size) bits.push("認知功能"+chipsToList(state.cognition));
      if(state.onTopic.size)   bits.push(Array.from(state.onTopic).map(v=>v+"切題對談").join("、"));

      if(state.noDisease){
        bits.push("無疾病史");
      }else if(state.diseases.size){
        const ds = chipsToList(state.diseases);
        const hos = state.hospitals.size ? "，規律於"+chipsToList(state.hospitals)+"追蹤" : "";
        bits.push("有"+ds+"疾病史"+hos);
      }

      if(state.skin.size) bits.push("個案皮膚"+chipsToList(state.skin));
      if(state.hasBedsore){
        const piece=[];
        piece.push("有壓瘡");
        if(state.bedsoreSites.size) piece.push("部位"+chipsToList(state.bedsoreSites));
        const area=(state.bedsoreArea||"").trim(); if(area) piece.push("面積約 "+area+" 公分");
        bits.push(piece.join("、"));
      }

      if(state.gait.size) bits.push("步態"+chipsToList(state.gait));
      if(state.useAid && state.aids.size) bits.push("行動需使用"+chipsToList(state.aids));
      if(state.adl.size) bits.push("日常生活自理"+chipsToList(state.adl));

      const para1 = `於${rocDate}訪視${parties}` + (bits.length? "，"+bits.join("；") : "") + "。";

      const more=[];
      if(state.cohab.size){
        const hasAlone = state.cohab.has("獨居");
        const others = Array.from(state.cohab).filter(v=>v!=="獨居");
        if(hasAlone && others.length===0)       more.push("個案獨居");
        else if(others.length)                  more.push("個案與"+others.join("、")+"同住");
      }
      if(state.housing.size) more.push("案家住所為"+chipsToList(state.housing));
      if(state.outdoor.size){
        const desc = Array.from(state.outdoor).map(v=> OUTDOOR_MAP[v]||v).join("、");
        more.push(desc);
      }
      if(state.support.size){
        const desc = Array.from(state.support).map(v=> SUPPORT_MAP[v]||v).join("、");
        more.push("評估"+desc);
      }

      // 主述需求 + 個管建議（同一片段，逗號銜接）
      if (state.demands.size || state.cmgr.size) {
        let t = "";
        if (state.demands.size) {
          t += "家屬主述有" + chipsToList(state.demands) + "需求";
        }
        if (state.cmgr.size) {
          t += (state.demands.size ? "，" : "") + "個管建議使用" + chipsToList(state.cmgr) + "服務";
        }
        more.push(t);
      }

      const para2 = more.length? ("\n\n"+more.join("；")+"。") : "";
      return [para1, para2].join("");
    }

    function gen2(){
      const list=chipsToList(state.issues), note=(state.needsNote||"").trim();
      const arr=[]; if(list) arr.push("主要需求/問題評估："+list); if(note) arr.push("補充："+note);
      return arr.length? arr.join("；")+"。" : "";
    }
    function gen3(){
      const list=chipsToList(state.goals), note=(state.goalsNote||"").trim();
      const arr=[]; if(list) arr.push("照顧目標："+list); if(note) arr.push("量化/補充："+note);
      return arr.length? arr.join("；")+"。" : "";
    }
    function gen4(){
      const list=chipsToList(state.services), sched=(state.serviceSched||"").trim(), note=(state.servicesNote||"").trim();
      const arr=[]; if(list) arr.push("服務計畫："+list); if(sched) arr.push("時程/頻率："+sched); if(note) arr.push("補充："+note);
      return arr.length? arr.join("；")+"。" : "";
    }
    function gen5(){
      const list=chipsToList(state.education), note=(state.educationNote||"").trim();
      const arr=[]; if(list) arr.push("風險與衛教："+list); if(note) arr.push("重點："+note);
      return arr.length? arr.join("；")+"。" : "";
    }
    function gen6(){
      const dateStr = state.nextDate? toROC(state.nextDate) : "____/__/__";
      const arr=["下次追蹤："+dateStr];
      if(state.followType.size) arr.push("方式："+chipsToList(state.followType));
      const who=(state.followOwner||"").trim(); if(who) arr.push("負責："+who);
      const note=(state.followNote||"").trim(); if(note) arr.push("備註："+note);
      return arr.join("，")+"。";
    }
    const generators={1:gen1,2:gen2,3:gen3,4:gen4,5:gen5,6:gen6};

    // 自動覆寫：僅 dirty=false 的段落才覆寫
    function maybeAuto(n){
      const text = generators[n]();
      if(!dirty[n]){ sections[n]= text; if(active===n) editor.value=text; }
    }

    // 初始渲染 & 綁定
    window.addEventListener("DOMContentLoaded", ()=>{
      $("visitDate").addEventListener("input", e=>{ state.visitDate=e.target.value; maybeAuto(1); });

      renderChips("parties",    VISIT_PARTIES, state.parties);
      renderChips("awareness",  AWARENESS,     state.awareness);
      renderChips("hearing",    HEARING,       state.hearing);
      renderChips("cognition",  COGNITION,     state.cognition);
      renderChips("onTopic",    ON_TOPIC,      state.onTopic);

      renderChips("diseases",   DISEASES,      state.diseases);
      renderChips("hospitals",  HOSPITALS,     state.hospitals);

      renderChips("skinIntegrity", SKIN_INTEGRITY, state.skin);
      renderChips("bedsoreSites",  BEDSORE_SITES,  state.bedsoreSites);

      renderChips("gait",       GAIT,          state.gait);
      renderChips("aids",       WALK_AID,      state.aids);
      renderChips("adl",        ADL_LEVEL,     state.adl);

      renderChips("cohab",      COHAB,         state.cohab);
      renderChips("housing",    HOUSING,       state.housing);
      renderChips("outdoor",    OUTDOOR,       state.outdoor);
      renderChips("support",    SUPPORT,       state.support);
      renderChips("demands",    DEMANDS,       state.demands);
      renderChips("cmgr",       DEMANDS,       state.cmgr);   // 新增：個管建議（同 DEMANDS）

      renderChips("issues",     ISSUES,        state.issues);
      renderChips("goals",      GOALS,         state.goals);
      renderChips("services",   SERVICES,      state.services);
      renderChips("education",  EDU_TOPICS,    state.education);
      renderChips("followType", FOLLOW_TYPES,  state.followType);

      // 旗標：壓瘡
      $("hasBedsore").addEventListener("change", e=>{
        state.hasBedsore = e.target.checked;
        $("bedsoreBlock").style.display = state.hasBedsore? "block" : "none";
        if(!state.hasBedsore){ state.bedsoreSites.clear(); state.bedsoreArea=""; $("bedsoreArea").value=""; }
        maybeAuto(1);
      });
      $("bedsoreArea").addEventListener("input", e=>{ state.bedsoreArea=e.target.value; maybeAuto(1); });

      // 無疾病史
      $("noDisease").addEventListener("change", e=>{
        state.noDisease = e.target.checked;
        $("diseases").style.opacity = state.noDisease ? 0.4 : 1;
        $("diseases").style.pointerEvents = state.noDisease ? "none" : "auto";
        $("hospitalRow").style.display = state.noDisease ? "none" : "block";
        if(state.noDisease){ state.diseases.clear(); state.hospitals.clear(); }
        maybeAuto(1);
      });

      // 輔具
      $("useAid").addEventListener("change", e=>{
        state.useAid = e.target.checked;
        $("useAidLabel").textContent = state.useAid ? "使用" : "未使用";
        $("aids").style.display = state.useAid ? "flex" : "none";
        if(!state.useAid) state.aids.clear();
        maybeAuto(1);
      });

      // 文字欄位
      $("needsNote").addEventListener("input", e=>{ state.needsNote=e.target.value; maybeAuto(2); });
      $("goalsNote").addEventListener("input", e=>{ state.goalsNote=e.target.value; maybeAuto(3); });
      $("serviceSched").addEventListener("input", e=>{ state.serviceSched=e.target.value; maybeAuto(4); });
      $("servicesNote").addEventListener("input", e=>{ state.servicesNote=e.target.value; maybeAuto(4); });
      $("educationNote").addEventListener("input", e=>{ state.educationNote=e.target.value; maybeAuto(5); });
      $("nextDate").addEventListener("input", e=>{ state.nextDate=e.target.value; maybeAuto(6); });
      $("followOwner").addEventListener("input", e=>{ state.followOwner=e.target.value; maybeAuto(6); });
      $("followNote").addEventListener("input", e=>{ state.followNote=e.target.value; maybeAuto(6); });

      // 段落勾選（影響複製範圍）
      document.querySelectorAll(".section-list input[type=checkbox]").forEach(cb=> cb.addEventListener("change", ()=>{}));

      // 複製全部
      $("copyBtn").addEventListener("click", async ()=>{
        const selected = [1,2,3,4,5,6].filter(i=> $("sec"+i).checked);
        const out = selected.map(n=>{
          const body=(sections[n]||"").trim();
          return body? `【第${n}段：${NAMES[n]}】\n${body}` : "";
        }).filter(Boolean).join("\n\n");
        try{
          await navigator.clipboard.writeText(out||"");
          const b=$("copyBtn"),t=b.textContent;b.textContent="已複製";setTimeout(()=>b.textContent=t,1200);
        }catch{ alert("無法複製，請手動選取文字。"); }
      });

      // 先跑一輪自動產生，然後切到第一段
      [1,2,3,4,5,6].forEach(maybeAuto);
      switchTo(1);
    });
  </script>
</body>
</html>
